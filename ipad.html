<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Tank Battle - iPad</title>
<style>
body { margin:0; background:#222; }
canvas { display:block; margin:auto; background:#333; }
</style>
</head>
<body>

<canvas id="game" width="1024" height="768"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* Firebase設定 */
const firebaseConfig = {  apiKey: "AIzaSyCzUHmyYcQlYkJmeXX5Cxp_fNFkonOSE3I",
  authDomain: "tcgtk-51f73.firebaseapp.com",
  databaseURL: "https://tcgtk-51f73-default-rtdb.firebaseio.com",
  projectId: "tcgtk-51f73",
  storageBucket: "tcgtk-51f73.firebasestorage.app",
  messagingSenderId: "379251900306",
  appId: "1:379251900306:web:beeb1989bedcca4dcbcb4b",
  measurementId: "G-HH57WGJM15"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ROOM_ID = "room_1";

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let players = {};
let inputs = {};
let bullets = [];

/* Firebase監視 */
onValue(ref(db, `rooms/${ROOM_ID}/players`), s => {
  players = s.val() || {};
});

onValue(ref(db, `rooms/${ROOM_ID}/inputs`), s => {
  inputs = s.val() || {};
});

/* 初期化 */
function addPlayer(playerId) {
  set(ref(db, `rooms/${ROOM_ID}/players/${playerId}`), {
    x: Math.random()*800+100,
    y: Math.random()*600+100,
    angle: 0,
    hp: 100
  });
}

window.addEventListener("keydown", e => {
  if (e.key === "a") addPlayer("playerA");
  if (e.key === "b") addPlayer("playerB");
});

/* ゲームループ */
function update() {
  for (const id in inputs) {
    const p = players[id];
    const input = inputs[id];
    if (!p) continue;

    p.x += input.moveX * 4;
    p.y += input.moveY * 4;
    p.angle = input.angle;

    if (input.fire) {
      bullets.push({
        owner: id,
        x: p.x,
        y: p.y,
        vx: Math.cos(p.angle * Math.PI/180) * 8,
        vy: Math.sin(p.angle * Math.PI/180) * 8
      });
    }

    update(ref(db, `rooms/${ROOM_ID}/players/${id}`), p);
  }

  bullets.forEach(b => {
    b.x += b.vx;
    b.y += b.vy;
  });

  draw();
  requestAnimationFrame(update);
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  for (const id in players) {
    const p = players[id];
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.angle * Math.PI/180);
    ctx.fillStyle = "green";
    ctx.fillRect(-20,-15,40,30);
    ctx.restore();
  }

  ctx.fillStyle = "yellow";
  bullets.forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x,b.y,4,0,Math.PI*2);
    ctx.fill();
  });
}

update();
</script>

</body>
</html>
